<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Municipio X - Biblioteca Elsa Morante</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
body,html{margin:0;padding:0;height:100%;width:100%}
#map{height:100vh;width:100%}
.search-box{position:absolute;top:10px;left:50px;z-index:1000;background:#fff;padding:10px;border-radius:5px;box-shadow:0 0 15px rgba(0,0,0,.2);display:flex;align-items:center}
.search-box input{width:250px;margin-right:10px;padding:5px 10px;border:1px solid #ccc;border-radius:3px;font-size:14px}
.search-box button{background-color:#4285f4;color:#fff;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;font-size:14px}
.search-box .icon{width:24px;height:24px;margin-right:10px;cursor:pointer}
.search-box .separator{width:1px;height:24px;background-color:#ccc;margin:0 10px}
.search-box input {
    width: 350px; /* Allarga la barra di ricerca */
}
.legend {
    background: rgba(255, 255, 255, 0.95);
    padding: 18px 22px;
    font: 13px/15px 'Segoe UI', system-ui, sans-serif;
    box-shadow: 0 5px 25px rgba(0,0,0,0.15);
    border-radius: 12px;
    position: absolute;
    bottom: 25px;
    right: 15px;
    z-index: 1000;
    max-height: 65vh;
    overflow-y: auto;
    width: 300px;
    border: 1px solid rgba(0,0,0,0.1);
    backdrop-filter: blur(4px);
    transition: all 0.3s ease;
}

.legend-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px 20px;
}

.legend-item {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    background: rgba(255,255,255,0.7);
    border: 1px solid transparent;
}

.legend-item:hover {
    background: rgba(241, 242, 246,0.6);
    transform: translateX(3px);
    border-color: #dfe4ea;
}

.legend-item.highlighted {
    background: #f8f9fa;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    border-color: #ced6e0;
}

.legend-item span {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    border-radius: 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.legend-item:hover span {
    transform: scale(1.1);
}

.legend-item .text {
    font-size: 13px;
    color: #4a5568;
    font-weight: 500;
    letter-spacing: 0.03em;
}

  .legend-item.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

.municipio-highlight {
    stroke-width: 4px !important;
    stroke-opacity: 0.9 !important;
    filter: drop-shadow(0 0 12px rgba(0,0,0,0.15));
    animation: pulseBorder 1.5s ease-in-out infinite;
}

.municipio-selected {
    stroke-width: 5px !important;
    stroke-opacity: 1 !important;
    fill-opacity: 0.2 !important;
    filter: drop-shadow(0 0 15px rgba(0, 0, 0, 0.3));
}

@keyframes pulseBorder {
    0% { stroke-width: 4px; }
    50% { stroke-width: 5px; }
    100% { stroke-width: 4px; }
}
.leaflet-routing-container{position:relative}
.routing-close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background-color: rgba(255, 77, 77, 0.7);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    z-index: 1000;
    transition: background-color 0.3s;
}

.routing-close-btn:hover {
    background-color: rgba(255, 26, 26, 0.8);
}
.custom-popup .leaflet-popup-content-wrapper {
    background-color: rgb(255, 255, 255);  /* Fully opaque white background */
    border-radius: 8px;
}

.custom-popup .leaflet-popup-tip {
    background-color: rgb(255, 255, 255);  /* Fully opaque white background */
}

.custom-popup {
    margin-bottom: 30px;
}

.custom-popup .leaflet-popup-close-button {
    color: #ff4d4d;
    font-size: 20px;
    font-weight: bold;
    opacity: 1;
    right: 8px;
    top: 8px;
}

.custom-popup .leaflet-popup-close-button:hover {
    color: #ff1a1a;
}
        .hours-info {
            margin-top: 10px;
            font-size: 12px;
            color: #333;
        }

        .baloon h3 {
    margin: 0 0 10px 0;
    color: #333;
}

.baloon p {
    margin: 0 0 10px 0;
    line-height: 1.4;
}

.baloon a {
    display: inline-block;
    text-decoration: none;
    margin-top: 5px;
}
body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
}

#map {
    height: 100vh;
    width: 100%;
}

#sidebar {
    position: fixed;
    top: 0;
    left: -300px;
    width: 300px;
    height: 100%;
    background: #fff;
    box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    transition: left 0.3s ease;
    z-index: 1000;
}

#sidebar.expanded {
    left: 0;
}

.sidebar-header {
    display: flex;
    flex-direction: column;
    padding: 10px;
    background: #f8f9fa;
    border-bottom: 1px solid #ddd;
}

.sidebar-button {
    margin: 5px 0;
    padding: 10px;
    background: #4285f4;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-align: left;
}

.sidebar-button:hover {
    background: #357abd;
}

.sidebar-content {
    padding: 10px;
    overflow-y: auto;
    height: calc(100% - 60px);
}

.sidebar-section {
    display: none;
}

.sidebar-section.active {
    display: block;
}

#route-search, #library-search {
    margin-bottom: 20px;
}

#route-input, #library-input {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

#route-submit {
    width: 100%;
    padding: 10px;
    background: #34a853;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

#route-submit:hover {
    background: #2d8a4a;
}

.legend-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.legend-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    cursor: pointer;
}

.legend-item span {
    width: 20px;
    height: 20px;
    margin-right: 10px;
    border-radius: 5px;
}

.legend-item .text {
    font-size: 14px;
    color: #333;
}
    </style>
</head>
<body>
        <div id="sidebar">
        <div class="sidebar-header">
            <button id="toggle-sidebar" class="sidebar-button">‚ò∞</button>
            <button id="search-route" class="sidebar-button">üîç Percorsi</button>
            <button id="search-library" class="sidebar-button">üìö Biblioteche</button>
            <button id="toggle-legend" class="sidebar-button">üó∫Ô∏è Legenda</button>
        </div>
        <div class="sidebar-content">
            <div id="route-search" class="sidebar-section">
                <input type="text" id="route-input" placeholder="Inserisci partenza...">
                <button id="route-submit">Cerca</button>
            </div>
            <div id="library-search" class="sidebar-section">
                <input type="text" id="library-input" placeholder="Cerca biblioteca..." list="libraries-list">
                <datalist id="libraries-list"></datalist>
            </div>
            <div id="legend" class="sidebar-section">
                <h4>Mappa Biblioteche di Roma per Municipi</h4>
                <div class="legend-grid"></div>
            </div>
        </div>
    </div>
    <div id="map"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="icons-config.js"></script> <!-- Aggiungi questa riga -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    
    <script>


        
 // Colori per i diversi municipi
const municipalityColors = {
    1: "#6a3f3a", // Marrone
    2: "#00faff", // Turchese
    3: "#fbd51c", // Giallo
    4: "#473e86", // Blu scuro
    5: "#018a87", // Verde acqua
    6: "#d33682", // Rosa
    7: "#ff7c4e", // Arancione
    8: "#22a825", // Verde erba
    9: "#2b83cb", // Blu cielo
    10: "#cb283c", // Rosso
    11: "#cac12e", // Giallo oliva
    12: "#a329ca", // Viola
    13: "#c9832c", // Arancione-marrone
    14: "#7b7b79", // Grigio
    15: "#000000"  // Nero
};



              // Funzione per convertire numeri in numeri romani
        function romanize(num) {
            const roman = ['I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV','XV'];
            return roman[num - 1] || num;
        }

        // Variabili globali 
        let currentBorder = null;
        let routingControl = null;
        let municipioLayer = null;
        let municipioLayers = {};
        let currentHighlight = null;
        let selectedMunicipio = null;


// Funzione helper per caricare e visualizzare il confine di un municipio
async function loadAndShowBorder(municipalityNumber, map) {
    // Se c'√® gi√† un confine visualizzato, rimuovilo
    if (currentBorder) {
        map.removeLayer(currentBorder);
    }

    try {
        const response = await fetch(`municipio${municipalityNumber}.geojson`);
        const data = await response.json();
        
       

        currentBorder = L.geoJSON(data, {
            style: {
                color: municipalityColors[municipalityNumber],
                weight: 3,
                opacity: 0.65,
                fillOpacity: 0.2  
            }
        }).addTo(map);

        map.fitBounds(currentBorder.getBounds());
    } catch (error) {
        console.error(`Errore nel caricamento del confine del municipio ${municipalityNumber}:`, error);
    }
}
        



        
document.addEventListener("DOMContentLoaded", async function() {
    const sidebar = document.getElementById('sidebar');
    const toggleSidebar = document.getElementById('toggle-sidebar');
    const searchRoute = document.getElementById('search-route');
    const searchLibrary = document.getElementById('search-library');
    const toggleLegend = document.getElementById('toggle-legend');
    const routeSearch = document.getElementById('route-search');
    const librarySearch = document.getElementById('library-search');
    const legend = document.getElementById('legend');

    toggleSidebar.addEventListener('click', function() {
        sidebar.classList.toggle('expanded');
    });

    searchRoute.addEventListener('click', function() {
        sidebar.classList.add('expanded');
        routeSearch.classList.add('active');
        librarySearch.classList.remove('active');
        legend.classList.remove('active');
    });

    searchLibrary.addEventListener('click', function() {
        sidebar.classList.add('expanded');
        librarySearch.classList.add('active');
        routeSearch.classList.remove('active');
        legend.classList.remove('active');
    });

    toggleLegend.addEventListener('click', function() {
        sidebar.classList.add('expanded');
        legend.classList.add('active');
        routeSearch.classList.remove('active');
        librarySearch.classList.remove('active');
    });

    // Codice originale per la mappa
    const center = [41.732522, 12.271879];
    const map = L.map("map").setView(center, 14);
    let libraryMarkers = {};

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "¬© OpenStreetMap contributors"
    }).addTo(map);

    // Definizione del percorso
    const pathPoints = [
        center,
        [41.732154, 12.271675],
        [41.732282, 12.271254],
        [41.73224, 12.27123],
        [41.732276, 12.27109],
        [41.732092, 12.27098]
    ];

    // Creazione della linea tratteggiata
    const dottedLine = L.polyline(pathPoints, {
        color: "#0000FF",
        weight: 4,
        opacity: 0.8,
        dashArray: "10, 10"
    }).addTo(map);

    // Punto finale del percorso
    const endPoint = pathPoints[pathPoints.length - 1];

    // Funzione per evidenziare la voce della legenda
    function highlightLegendItem(municipioNumber) {
        const allItems = document.querySelectorAll('.legend-item');
        allItems.forEach(item => item.classList.remove('highlighted'));
        const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
        if (item) {
            item.classList.add('highlighted');
        }
    }

    // Definizione della funzione createMarker
    function createMarker(coords, title, icon, popupContent, municipioNumber, map) {
        const marker = L.marker(coords, { title, icon })
            .addTo(map)
            .on('click', () => {
                if (selectedMunicipio === municipioNumber) {
                    // Deseleziona se cliccato nuovamente
                    if (currentBorder) {
                        map.removeLayer(currentBorder);
                        currentBorder = null;
                    }
                    selectedMunicipio = null;
                    const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
                    if (item) {
                        item.classList.remove('highlighted');
                    }
                } else {
                    // Seleziona il municipio
                    loadAndShowBorder(municipioNumber, map);
                    highlightLegendItem(municipioNumber);
                    selectedMunicipio = municipioNumber;
                }
            });

        const popup = L.popup({
            className: 'custom-popup',
            offset: [0, -10],
            closeButton: true
        }).setContent(popupContent);
        marker.bindPopup(popup);
        return marker;
    }

    const icons = getIconsConfig();

    // Spazio dove erano i marker per le biblioteche...
    // Popola il datalist e crea i marker
    try {
        const response = await fetch('libraries.json');
        const data = await response.json();
        const datalist = document.getElementById('libraries-list');

        // Aggiungi Elsa Morante al datalist
        const moranteOption = document.createElement('option');
        moranteOption.value = "Biblioteca Elsa Morante";
        datalist.appendChild(moranteOption);

        // Crea marker e popola datalist
        data.libraries.forEach(library => {
            // Aggiungi opzione al datalist
            const option = document.createElement('option');
            option.value = library.name;
            datalist.appendChild(option);

            // Crea marker
            const popupContent = `
                <div class="baloon">
                    <h3>${library.name}</h3>
                    <p style="font-size: 15px;">
                        ${library.address} <br>
                        ${library.cap} Municipio ${library.municipalityName}
                    </p>
                    <a style="color: #bc0b34; font-size: 16px;" href="${library.url}">
                        Vai alla scheda
                    </a>
                </div>
            `;
            const marker = createMarker(
                library.coords,
                library.name,
                icons[`municipio${library.municipality}`],
                popupContent,
                library.municipality,
                map
            );
            libraryMarkers[library.name] = marker;
        });

        // Crea marker per Elsa Morante (non presente nel JSON)
        const moranteMarker = createMarker(
            center,
            "Biblioteca Elsa Morante",
            icons.municipio10,
            `<div class="baloon">
                <h3>Biblioteca Elsa Morante</h3>
                <p style="font-size: 15px;">
                    Via Adolfo Cozza, 7, 00121 Lido di Ostia RM<br>
                    00121 Municipio X
                </p>
                <a style="color: #bc0b34; font-size: 16px;" href="https://www.bibliotechediroma.it/opac/library/Biblioteca%20Elsa%20Morante/RMBO2">
                    Vai alla scheda
                </a>
            </div>`,
            10,
            map
        );
        libraryMarkers["Biblioteca Elsa Morante"] = moranteMarker;
    } catch (error) {
        console.error('Errore nel caricamento delle biblioteche:', error);
    }

    // Gestione eventi per la ricerca
    document.getElementById('library-search').addEventListener('change', function(e) {
        const value = e.target.value;
        if (libraryMarkers[value]) {
            libraryMarkers[value].fire('click');
            e.target.value = '';
        }
    });

    document.getElementById('library-search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const startPoint = e.target.value;
            if (startPoint.trim()) {
                searchRoute(startPoint);
            }
        }
    });
});

async function showMunicipioI() {
    // Rimuovi il layer precedente se esiste
    if (municipioLayer) {
        map.removeLayer(municipioLayer);
    }
    try {
        const response = await fetch('municipio1.geojson');
        const data = await response.json();
        municipioLayer = L.geoJSON(data, {
            style: {
                color: '#6a3f3a',
                weight: 3,
                opacity: 0.65,
                fillOpacity: 0.2
            }
        }).addTo(map);
        map.fitBounds(municipioLayer.getBounds());
    } catch (error) {
        console.error('Errore nel caricamento del confine:', error);
    }
}

window.searchRoute = async function(startPoint) {
    if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
    }
    try {
        const response = await axios.get('https://nominatim.openstreetmap.org/search', {
            params: {
                q: startPoint,
                format: 'json',
                limit: 1
            }
        });
        if (response.data.length > 0) {
            const startCoords = [
                parseFloat(response.data[0].lat),
                parseFloat(response.data[0].lon)
            ];
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(startCoords[0], startCoords[1]),
                    L.latLng(center[0], center[1])
                ],
                // ... resto della configurazione originale
            }).addTo(map);
        } else {
            alert('Indirizzo non trovato. Riprova.');
        }
    } catch (error) {
        console.error('Errore nella ricerca del percorso:', error);
        alert('Errore nel trovare il percorso. Riprova.');
    }
}

// Fetch and display the municipality border
fetch('municipio10.geojson')
    .then(response => response.json())
    .then(data => {
        // Carica il municipio X di default
        municipioLayers[10] = L.geoJSON(data, {
            style: {
                color: municipalityColors[10],
                weight: 3,
                opacity: 0.65,
                fillOpacity: 0
            }
        }).addTo(map);

        // Aggiungi la legenda interattiva
        const legend = L.control({ position: 'bottomright' });

        // Replace the legend.onAdd function with this corrected version
        legend.onAdd = function() {
            const div = L.DomUtil.create("div", "legend");
            div.innerHTML = `
                <h4>Mappa Biblioteche di Roma per Municipi</h4>
                <div class="legend-grid">
                    ${Object.entries(municipalityColors).map(([num, color]) => `
                        <div class="legend-item ${num === '10' ? 'disabled' : ''}" data-municipio="${num}" ${num !== '10' ? `onmouseover="handleLegendHover(${num})" onmouseout="handleLegendOut(${num})" onclick="handleLegendClick(${num})"` : ''}>
                            <span style="background: ${color}"></span>
                            <div class="text">Municipio ${romanize(parseInt(num))}</div>
                        </div>
                    `).join("")}
                </div>
            `;
            return div;
        };
        legend.addTo(map);

        // Gestore hover sulla legenda
        // Funzione per gestire l'hover sulla legenda
        window.handleLegendHover = async function(municipioNumber) {
            // Non mostrare l'hover se il municipio √® gi√† selezionato
            if (municipioNumber === selectedMunicipio) return;
            const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
            item.classList.add('highlighted');
            if (!municipioLayers[municipioNumber]) {
                try {
                    const response = await fetch(`municipio${municipioNumber}.geojson`);
                    const data = await response.json();
                    municipioLayers[municipioNumber] = L.geoJSON(data, {
                        style: {
                            color: municipalityColors[municipioNumber],
                            weight: 4,
                            opacity: 0.9,
                            fillOpacity: 0.1
                        }
                    });
                } catch (error) {
                    console.error(`Error loading municipality ${municipioNumber}:`, error);
                    return;
                }
            }
            if (currentHighlight && currentHighlight !== currentBorder) {
                map.removeLayer(currentHighlight);
            }
            currentHighlight = municipioLayers[municipioNumber].addTo(map).bringToFront();
        };

        // Funzione per gestire l'uscita del mouse dalla legenda
        window.handleLegendOut = function(municipioNumber) {
            if (municipioNumber === selectedMunicipio) return;
            const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
            item.classList.remove('highlighted');
            if (currentHighlight && currentHighlight !== currentBorder) {
                map.removeLayer(currentHighlight);
                currentHighlight = null;
            }
            // Se c'√® un municipio selezionato, assicurati che rimanga visibile
            if (selectedMunicipio && currentBorder) {
                currentBorder.bringToFront();
            }
        };

        // Funzione per gestire il click sulla legenda
        window.handleLegendClick = async function(municipioNumber) {
            const allItems = document.querySelectorAll('.legend-item');
            allItems.forEach(item => item.classList.remove('highlighted'));
            if (selectedMunicipio === municipioNumber) {
                if (currentBorder) {
                    map.removeLayer(currentBorder);
                    currentBorder = null;
                }
                selectedMunicipio = null;
                return;
            }
            if (!municipioLayers[municipioNumber]) {
                try {
                    const response = await fetch(`municipio${municipioNumber}.geojson`);
                    const data = await response.json();
                    municipioLayers[municipioNumber] = L.geoJSON(data, {
                        style: {
                            color: municipalityColors[municipioNumber],
                            weight: 4,
                            opacity: 0.9,
                            fillOpacity: 0.2
                        }
                    });
                } catch (error) {
                    console.error(`Error loading municipality ${municipioNumber}:`, error);
                    return;
                }
            }
            if (currentBorder) {
                map.removeLayer(currentBorder);
            }
            selectedMunicipio = municipioNumber;
            const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
            if (item) {
                item.classList.add('highlighted');
            }
            currentBorder = municipioLayers[municipioNumber].addTo(map).bringToFront();
            map.fitBounds(currentBorder.getBounds());
        };
    })
    .catch(error => console.error('Errore nel caricamento dei confini:', error));
});
        
    </script>
</body>
</html>
