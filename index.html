<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappa Municipio X - Biblioteca Elsa Morante</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        #map {
            height: 100vh;
            width: 100%;
        }
.search-box{position:absolute;top:10px;left:50px;z-index:1000;background:#fff;padding:10px;border-radius:5px;box-shadow:0 0 15px rgba(0,0,0,.2);display:flex;align-items:center}
.search-box input{width:250px;margin-right:10px;padding:5px 10px;border:1px solid #ccc;border-radius:3px;font-size:14px}
.search-box button{background-color:#4285f4;color:#fff;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;font-size:14px}
.search-box .icon{width:24px;height:24px;margin-right:10px;cursor:pointer}
.search-box .separator{width:1px;height:24px;background-color:#ccc;margin:0 10px}

        
        /* Barra laterale fissa */
        .sidebar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 60px; /* Larghezza fissa */
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }
        .sidebar button {
            background: none;
            border: none;
            cursor: pointer;
            margin-bottom: 20px;
        }
  .sidebar button img {
    width: 24px;
    height: 24px;
    padding: 0;
    margin: 0;
}

        /* Seconda barra laterale (espansione) */
        .sidebar-expanded {
            position: absolute;
            top: 0;
            left: 60px; /* Parte dalla fine della barra fissa */
            height: 100%;
            width: 0; /* Inizialmente nascosta */
            background: #f4f7f0; /* Colore di sfondo */
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 999;
            transition: width 0.3s ease;
            overflow: hidden;
        }
        .sidebar-expanded.open {
            width: 300px; /* Larghezza espansa */
        }

        /* Casella di ricerca */
        /* Stile per il pannello di ricerca */
.search-container {
    position: relative; /* Permette di posizionare il riquadro dei risultati relativamente a questo contenitore */
    padding: 20px;
    display: none;
}
        .sidebar-expanded.open .search-container {
            display: block; /* Mostra la casella di ricerca */
        }
        .search-container input {
            width: 100%;
            padding: 8px;
            border: 1px solid #4285f4; /* Contorno blu */
            border-radius: 4px; /* Bordi arrotondati */
            font-size: 14px;
            outline: none; /* Rimuove il bordo predefinito */
        }
        .search-container button {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background-color: #4285f4;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }


.legend.visible {
    right: 0;
}

.legend {
    display: block;
    background: rgba(255, 255, 255, 0.95);
    padding: 15px 20px;  /* Padding bilanciato */
    font: 13px/15px 'Segoe UI', system-ui, sans-serif;
    box-shadow: 0 5px 25px rgba(0,0,0,0.15);
    border-radius: 12px 0 0 12px;
    position: fixed;
    top: 0;
    right: -350px;
    height: 100vh;
    z-index: 1000;
    width: 250px;
    border: 1px solid rgba(0,0,0,0.1);
    backdrop-filter: blur(4px);
    transition: right 0.3s ease;
}

.legend h4 {
    margin: 0 0 12px 0;  /* Margin più bilanciato */
    font-size: 14px;
}

.legend-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 6px;           /* Gap intermedio tra gli elementi */
}

.legend-item {
    display: flex;
    align-items: center;
    padding: 6px 10px;   /* Padding bilanciato */
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    background: rgba(255,255,255,0.7);
    border: 1px solid transparent;
}

.legend-item span {
    width: 18px;         /* Dimensione icona bilanciata */
    height: 18px;
    margin-right: 10px;  /* Margin bilanciato */
    border-radius: 4px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
        

.legend-item:hover {
    background: rgba(241, 242, 246,0.6);
    transform: translateX(3px);
    border-color: #dfe4ea;
}

.legend-item.highlighted {
    background: #f8f9fa;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    border-color: #ced6e0;
}



.legend-item:hover span {
    transform: scale(1.1);
}

.legend-item .text {
    font-size: 13px;
    color: #4a5568;
    font-weight: 500;
    letter-spacing: 0.02em;
}

  .legend-item.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

.municipio-highlight {
    stroke-width: 4px !important;
    stroke-opacity: 0.9 !important;
    filter: drop-shadow(0 0 12px rgba(0,0,0,0.15));
    animation: pulseBorder 1.5s ease-in-out infinite;
}

.municipio-selected {
    stroke-width: 5px !important;
    stroke-opacity: 1 !important;
    fill-opacity: 0.2 !important;
    filter: drop-shadow(0 0 15px rgba(0, 0, 0, 0.3));
}

@keyframes pulseBorder {
    0% { stroke-width: 4px; }
    50% { stroke-width: 5px; }
    100% { stroke-width: 4px; }
}
.leaflet-routing-container{position:relative}
.routing-close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    background-color: rgba(255, 77, 77, 0.7);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    z-index: 1000;
    transition: background-color 0.3s;
}

.routing-close-btn:hover {
    background-color: rgba(255, 26, 26, 0.8);
}
.custom-popup .leaflet-popup-content-wrapper {
    background-color: rgb(255, 255, 255);  /* Fully opaque white background */
    border-radius: 8px;
}

.custom-popup .leaflet-popup-tip {
    background-color: rgb(255, 255, 255);  /* Fully opaque white background */
}

.custom-popup {
    margin-bottom: 30px;
}

.custom-popup .leaflet-popup-close-button {
    color: #ff4d4d;
    font-size: 20px;
    font-weight: bold;
    opacity: 1;
    right: 8px;
    top: 8px;
}

.custom-popup .leaflet-popup-close-button:hover {
    color: #ff1a1a;
}
        .hours-info {
            margin-top: 10px;
            font-size: 12px;
            color: #333;
        }

        .baloon h3 {
    margin: 0 0 10px 0;
    color: #333;
}

.baloon p {
    margin: 0 0 10px 0;
    line-height: 1.4;
}

.baloon a {
    display: inline-block;
    text-decoration: none;
    margin-top: 5px;
}


/* Stile per il riquadro dei risultati */
#search-results {
  position: relative; /* Cambia da absolute a relative */
  top: auto; /* Rimuovi il posizionamento assoluto */
  left: auto; /* Rimuovi il posizionamento assoluto */
  width: 100%; /* Larghezza piena del pannello */
  max-height: 400px; /* Altezza massima con scroll */
  overflow-y: auto; /* Abilita lo scroll se necessario */
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  padding: 15px;
  margin-top: 20px; /* Spazio sopra il riquadro */
  border: 1px solid #e0e0e0;
  z-index: 1; /* Assicurati che sia sopra altri elementi */
}

/* Stile per il titolo del municipio */
#search-results .municipio-title {
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid #e0e0e0;
}

/* Stile per ogni voce di biblioteca */
#search-results .library-item {
  padding: 8px 12px;
  margin: 5px 0;
  border-radius: 6px;
  background-color: #f9f9f9;
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.2s ease;
  font-size: 14px;
  color: #555;
  border: 1px solid #e0e0e0;
}

/* Effetto hover sulle voci di biblioteca */
#search-results .library-item:hover {
  background-color: #f1f1f1;
  transform: translateX(5px);
  border-color: #4285f4;
}

/* Scrollbar personalizzata */
#search-results::-webkit-scrollbar {
  width: 8px;
}

#search-results::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

#search-results::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}

#search-results::-webkit-scrollbar-thumb:hover {
  background: #555;
}

        
    </style>
</head>
<body>
    <!-- Barra laterale fissa -->
    <div class="sidebar">
        <button onclick="toggleExpandedSidebar()">
            <img src="sidebar.svg" alt="Menu">
        </button>
        <button onclick="toggleLibrarySearch()">
            <img src="search-icon.svg" alt="Cerca biblioteca">
        </button>
        <button onclick="toggleStreetSearch()">
            <img src="street-search.svg" alt="Cerca indirizzo">
        </button>
        <button onclick="toggleLegend()">
            <img src="legend-icon.svg" alt="Mostra/Nascondi legenda">
        </button>
    </div>

    <!-- Seconda barra laterale (espansione) -->
<!-- Seconda barra laterale (espansione) -->
<div class="sidebar-expanded" id="expandedSidebar">
  <div class="search-container" id="searchContainer">
    <input type="text" id="start-point" placeholder="Inserisci punto di partenza" list="library-suggestions">
    <datalist id="library-suggestions">
      <!-- Opzioni verranno aggiunte via JavaScript -->
    </datalist>
    <button onclick="searchRoute()">Trova Percorso</button>
  </div>
  <!-- Aggiungi il contenitore dei risultati qui -->
  <div id="search-results"></div>
</div>

    <div id="map"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="icons-config.js"></script> <!-- Aggiungi questa riga -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    
    <script>

 // Colori per i diversi municipi
const municipalityColors = {
    1: "#6a3f3a", // Marrone
    2: "#00faff", // Turchese
    3: "#fbd51c", // Giallo
    4: "#473e86", // Blu scuro
    5: "#018a87", // Verde acqua
    6: "#d33682", // Rosa
    7: "#ff7c4e", // Arancione
    8: "#22a825", // Verde erba
    9: "#2b83cb", // Blu cielo
    10: "#cb283c", // Rosso
    11: "#cac12e", // Giallo oliva
    12: "#a329ca", // Viola
    13: "#c9832c", // Arancione-marrone
    14: "#7b7b79", // Grigio
    15: "#000000"  // Nero
};



              // Funzione per convertire numeri in numeri romani
        function romanize(num) {
            const roman = ['I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII','XIII','XIV','XV'];
            return roman[num - 1] || num;
        }

        // Variabili globali 
        let currentBorder = null;
        let routingControl = null;
        let municipioLayer = null;
        let municipioLayers = {};
        let currentHighlight = null;
        let selectedMunicipio = null;

      // Funzione per aprire/chiudere la seconda barra laterale
        function toggleExpandedSidebar() {
            const expandedSidebar = document.getElementById('expandedSidebar');
            expandedSidebar.classList.toggle('open');
        }

// Add this new function for legend toggle
function toggleLegend() {
    const legend = document.querySelector('.legend');
    if (legend) {
        legend.classList.toggle('visible');
    }
}


// Funzione per cercare una biblioteca e aprire il popup corrispondente
async function searchLibrary() {
    const searchTerm = document.getElementById('start-point').value.toLowerCase();
    if (!searchTerm) return;

    try {
        const response = await fetch('libraries.json');
        const data = await response.json();

        // Trova la biblioteca cercata
        const foundLibrary = data.libraries.find(library =>
            library.name.toLowerCase().includes(searchTerm)
        );

        if (foundLibrary) {
            // Trova tutte le biblioteche dello stesso municipio
            const librariesInMunicipio = data.libraries.filter(library =>
                library.municipality === foundLibrary.municipality
            );

            // Mostra il municipio e le biblioteche
            showMunicipioAndLibraries(foundLibrary.municipality, librariesInMunicipio);
        } else {
            alert('Biblioteca non trovata. Riprova.');
        }
    } catch (error) {
        console.error('Errore nella ricerca della biblioteca:', error);
        alert('Errore nella ricerca. Riprova.');
    }
}

function showMunicipioAndLibraries(municipioNumber, libraries) {
  // Rimuovi i risultati precedenti
  const existingResults = document.getElementById('search-results');
  if (existingResults) {
    existingResults.innerHTML = ''; // Svuota il contenuto invece di rimuoverlo
  } else {
    const resultsContainer = document.createElement('div');
    resultsContainer.id = 'search-results';
    document.getElementById('expandedSidebar').appendChild(resultsContainer);
  }

  // Aggiungi il titolo del municipio
  const municipioDiv = document.createElement('div');
  municipioDiv.className = 'municipio-title';
  municipioDiv.textContent = `Municipio ${romanize(municipioNumber)}`;
  resultsContainer.appendChild(municipioDiv);

  // Aggiungi le biblioteche del municipio
  libraries.forEach(library => {
    const libraryDiv = document.createElement('div');
    libraryDiv.className = 'library-item';
    libraryDiv.textContent = library.name;
    libraryDiv.onclick = () => selectLibrary(library);
    resultsContainer.appendChild(libraryDiv);
  });
}

    // Aggiungi i risultati al DOM
    document.body.appendChild(resultsContainer);

    // Evidenzia il municipio sulla mappa
    loadAndShowBorder(municipioNumber, map);
    highlightLegendItem(municipioNumber);
    selectedMunicipio = municipioNumber;
}


function selectLibrary(library) {
    let foundMarker = null;
    map.eachLayer((layer) => {
        if (layer instanceof L.Marker) {
            const pos = layer.getLatLng();
            if (pos.lat === library.coords[0] && pos.lng === library.coords[1]) {
                foundMarker = layer;
            }
        }
    });

    if (foundMarker) {
        foundMarker.openPopup();
        map.setView(foundMarker.getLatLng(), 14);
        loadAndShowBorder(library.municipality, map);
        highlightLegendItem(library.municipality);
        selectedMunicipio = library.municipality;
    } else {
        console.log('Marker not found for library:', library);
    }

    // Rimuovi i risultati della ricerca
    const resultsContainer = document.getElementById('search-results');
    if (resultsContainer) {
        resultsContainer.remove();
    }
}

        
function toggleLibrarySearch() {
    const expandedSidebar = document.getElementById('expandedSidebar');
    const searchContainer = document.getElementById('searchContainer');
    
    expandedSidebar.classList.add('open');
    
    const startPointInput = document.getElementById('start-point');
    const searchButton = searchContainer.querySelector('button');
    startPointInput.placeholder = "Cerca una biblioteca...";
    searchButton.textContent = "Cerca Biblioteca";
    
    searchButton.onclick = searchLibrary;
    
    searchContainer.style.display = 'block';
}

// Make functions globally accessible
window.searchLibrary = searchLibrary;
window.toggleLibrarySearch = toggleLibrarySearch;


        
        // Funzione per attivare la ricerca indirizzo
function toggleStreetSearch() {
    const expandedSidebar = document.getElementById('expandedSidebar');
    const searchContainer = document.getElementById('searchContainer');
    
    // Apri la barra laterale
    expandedSidebar.classList.add('open');
    
    // Modifica il placeholder e il testo del pulsante
    const startPointInput = document.getElementById('start-point');
    const searchButton = searchContainer.querySelector('button');
    
    startPointInput.placeholder = "Inserisci punto di partenza";
    searchButton.textContent = "Trova Percorso";
    
    // Mostra la casella di ricerca
    searchContainer.style.display = 'block';
}
        
// Funzione helper per caricare e visualizzare il confine di un municipio
async function loadAndShowBorder(municipalityNumber, map) {
    // Se c'è già un confine visualizzato, rimuovilo
    if (currentBorder) {
        map.removeLayer(currentBorder);
    }

    try {
        const response = await fetch(`municipio${municipalityNumber}.geojson`);
        const data = await response.json();
        
       

        currentBorder = L.geoJSON(data, {
            style: {
                color: municipalityColors[municipalityNumber],
                weight: 3,
                opacity: 0.65,
                fillOpacity: 0.2  
            }
        }).addTo(map);

        map.fitBounds(currentBorder.getBounds());
    } catch (error) {
        console.error(`Errore nel caricamento del confine del municipio ${municipalityNumber}:`, error);
    }
}
        



let map;

// Funzione per evidenziare la voce della legenda
function highlightLegendItem(municipioNumber) {
  const allItems = document.querySelectorAll('.legend-item');
  allItems.forEach(item => item.classList.remove('highlighted'));
  const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
  if (item) {
    item.classList.add('highlighted');
  }
}
window.highlightLegendItem = highlightLegendItem;

        
document.addEventListener("DOMContentLoaded", async function() {
    // Initialize map
    const center = [41.732522, 12.271879];
    map = L.map("map", {
        zoomControl: false
    }).setView(center, 14);
            
            // Add zoom control to the right side
            L.control.zoom({
                position: 'topright'
            }).addTo(map);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    // Definizione del percorso
    const pathPoints = [
        center,
        [41.732154, 12.271675],
        [41.732282, 12.271254],
        [41.73224, 12.27123],
        [41.732276, 12.27109],
        [41.732092, 12.27098]
    ];

    // Creazione della linea tratteggiata
    const dottedLine = L.polyline(pathPoints, {
        color: "#0000FF",
        weight: 4,
        opacity: 0.8,
        dashArray: "10, 10"
    }).addTo(map);

    // Punto finale del percorso
    const endPoint = pathPoints[pathPoints.length - 1];


    
    // Definizione della funzione createMarker
function createMarker(coords, title, icon, popupContent, municipioNumber, map) {
    const marker = L.marker(coords, { title, icon })
        .addTo(map)
        .on('click', () => {
            if (selectedMunicipio === municipioNumber) {
                // Deseleziona se cliccato nuovamente
                if (currentBorder) {
                    map.removeLayer(currentBorder);
                    currentBorder = null;
                }
                selectedMunicipio = null;
                const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
                if (item) {
                    item.classList.remove('highlighted');
                }
            } else {
                // Seleziona il municipio
                loadAndShowBorder(municipioNumber, map);
                highlightLegendItem(municipioNumber);
                selectedMunicipio = municipioNumber;
            }
        });

        const popup = L.popup({
            className: 'custom-popup',
            offset: [0, -10],
            closeButton: true
        }).setContent(popupContent);

        marker.bindPopup(popup);
        return marker;
    }

const icons = getIconsConfig();
  

// Spazio dove erano i marker per le biblioteche...
// Carica le biblioteche dal file JSON
// Dopo aver caricato le biblioteche dal file JSON
try {
    const response = await fetch('libraries.json');
    const data = await response.json();

    // Popola il datalist con i nomi delle biblioteche
    const datalist = document.getElementById('library-suggestions');
    data.libraries.forEach(library => {
        const option = document.createElement('option');
        option.value = library.name;
        datalist.appendChild(option);
    });

    // Crea i marker per ogni biblioteca
    data.libraries.forEach(library => {
        const popupContent = `
            <div class="baloon">
                <h3>${library.name}</h3>
                <p style="font-size: 15px;">
                    ${library.address} <br>
                    ${library.cap} Municipio ${library.municipalityName}
                </p>
                <a style="color: #bc0b34; font-size: 16px;" href="${library.url}">
                    Vai alla scheda
                </a>
            </div>
        `;
        createMarker(
            library.coords,
            library.name,
            icons[`municipio${library.municipality}`],
            popupContent,
            library.municipality,
            map
        );
    });
} catch (error) {
    console.error('Errore nel caricamento delle biblioteche:', error);
}
    


    
  



   async function showMunicipioI() {
  // Rimuovi il layer precedente se esiste
  if (municipioLayer) {
    map.removeLayer(municipioLayer);
  }
  
  try {
    const response = await fetch('municipio1.geojson');
    const data = await response.json();
    
    municipioLayer = L.geoJSON(data, {
      style: {
        color: '#6a3f3a',
        weight: 3,
        opacity: 0.65,
        fillOpacity: 0.2
      }
    }).addTo(map);
    
    map.fitBounds(municipioLayer.getBounds());
  } catch (error) {
    console.error('Errore nel caricamento del confine:', error);
  }
}





    
            window.searchRoute = async function() {
                const startPoint = document.getElementById('start-point').value;
                
                if (routingControl) {
                    map.removeControl(routingControl);
                }

                try {
                    const response = await axios.get('https://nominatim.openstreetmap.org/search', {
                        params: {
                            q: startPoint,
                            format: 'json',
                            limit: 1
                        }
                    });

                    if (response.data.length > 0) {
                        const startCoords = [
                            parseFloat(response.data[0].lat), 
                            parseFloat(response.data[0].lon)
                        ];

                        routingControl = L.Routing.control({
                            waypoints: [
                                L.latLng(startCoords[0], startCoords[1]),
                                L.latLng(center[0], center[1])
                            ],
                            routeWhileDragging: true,
                            language: 'it',
                            show: true,
                            addWaypoints: false,
                            draggableWaypoints: false,
                            fitSelectedRoutes: true,
                            lineOptions: {
                                styles: [{color: '#0000FF', opacity: 0.8, weight: 5}]
                            },
                            createMarker: function(i, waypoint, n) {
                                const closeBtn = document.createElement('button');
                                closeBtn.innerHTML = '✕';
                                closeBtn.className = 'routing-close-btn';
                                closeBtn.onclick = function() {
                                    map.removeControl(routingControl);
                                };

                                // Append close button to routing container
                                setTimeout(() => {
                                    const container = document.querySelector('.leaflet-routing-container');
                                    if (container) {
                                        container.appendChild(closeBtn);
                                    }
                                }, 100);

                                return null; // No markers for waypoints
                            }
                        }).addTo(map);
                    } else {
                        alert('Indirizzo non trovato. Riprova.');
                    }
                } catch (error) {
                    console.error('Errore nella ricerca del percorso:', error);
                    alert('Errore nel trovare il percorso. Riprova.');
                }
            }

document.getElementById('start-point').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        const searchButton = document.querySelector('#searchContainer button');
        if (searchButton.textContent === "Cerca Biblioteca") {
            searchLibrary();
        } else {
            searchRoute();
        }
    }
});

            document.getElementById('start-point').focus();



// Fetch and display the municipality border
fetch('municipio10.geojson')
    .then(response => response.json())
    .then(data => {


       

        // Carica il municipio X di default
        municipioLayers[10] = L.geoJSON(data, {
            style: {
                color: municipalityColors[10],
                weight: 3,
                opacity: 0.65,
                fillOpacity: 0
            }
        }).addTo(map);

        // Aggiungi la legenda interattiva
         const legend = L.control({ position: 'topright' });
   // Replace the legend.onAdd function with this corrected version
legend.onAdd = function() {
    const div = L.DomUtil.create("div", "legend");
    


    div.innerHTML = `
        <h4>Mappa Biblioteche di Roma per Municipio</h4>
        <div class="legend-grid">
            ${Object.entries(municipalityColors).map(([num, color]) => `
                <div class="legend-item ${num === '10' ? 'disabled' : ''}" 
                     data-municipio="${num}" 
                     ${num !== '10' ? `onmouseover="handleLegendHover(${num})" 
                     onmouseout="handleLegendOut(${num})" 
                     onclick="handleLegendClick(${num})"` : ''}>
                    <span style="background: ${color}"></span>
                    <div class="text">Municipio ${romanize(parseInt(num))}</div>
                </div>
            `).join("")}
        </div>
    `;
    
    return div;
};
    legend.addTo(map);

  

        // Gestore hover sulla legenda
// Funzione per gestire l'hover sulla legenda
window.handleLegendHover = async function(municipioNumber) {
                // Non mostrare l'hover se il municipio è già selezionato
                if (municipioNumber === selectedMunicipio) return;

                const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
                item.classList.add('highlighted');

                if (!municipioLayers[municipioNumber]) {
                    try {
                        const response = await fetch(`municipio${municipioNumber}.geojson`);
                        const data = await response.json();
                        municipioLayers[municipioNumber] = L.geoJSON(data, {
                            style: {
                                color: municipalityColors[municipioNumber],
                                weight: 4,
                                opacity: 0.9,
                                fillOpacity: 0.1
                            }
                        });
                    } catch (error) {
                        console.error(`Error loading municipality ${municipioNumber}:`, error);
                        return;
                    }
                }

                if (currentHighlight && currentHighlight !== currentBorder) {
                    map.removeLayer(currentHighlight);
                }
                
                currentHighlight = municipioLayers[municipioNumber].addTo(map).bringToFront();
            };

            // Funzione per gestire l'uscita del mouse dalla legenda
            window.handleLegendOut = function(municipioNumber) {
                if (municipioNumber === selectedMunicipio) return;

                const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
                item.classList.remove('highlighted');

                if (currentHighlight && currentHighlight !== currentBorder) {
                    map.removeLayer(currentHighlight);
                    currentHighlight = null;
                }

                // Se c'è un municipio selezionato, assicurati che rimanga visibile
                if (selectedMunicipio && currentBorder) {
                    currentBorder.bringToFront();
                }
            };

            // Funzione per gestire il click sulla legenda
window.handleLegendClick = async function(municipioNumber) {
    const allItems = document.querySelectorAll('.legend-item');
    allItems.forEach(item => item.classList.remove('highlighted'));

    if (selectedMunicipio === municipioNumber) {
        if (currentBorder) {
            map.removeLayer(currentBorder);
            currentBorder = null;
        }
        selectedMunicipio = null;
        return;
    }

    if (!municipioLayers[municipioNumber]) {
        try {
            const response = await fetch(`municipio${municipioNumber}.geojson`);
            const data = await response.json();
            municipioLayers[municipioNumber] = L.geoJSON(data, {
                style: {
                    color: municipalityColors[municipioNumber],
                    weight: 4,
                    opacity: 0.9,
                    fillOpacity: 0.2
                }
            });
        } catch (error) {
            console.error(`Error loading municipality ${municipioNumber}:`, error);
            return;
        }
    }

    if (currentBorder) {
        map.removeLayer(currentBorder);
    }

    selectedMunicipio = municipioNumber;
    const item = document.querySelector(`.legend-item[data-municipio="${municipioNumber}"]`);
    if (item) {
        item.classList.add('highlighted');
    }

    currentBorder = municipioLayers[municipioNumber].addTo(map).bringToFront();
    map.fitBounds(currentBorder.getBounds());
};
        })
        .catch(error => console.error('Errore nel caricamento dei confini:', error));
});
    </script>
</body>
</html>
